#!/usr/bin/env bash

# Development environment script for Docker
# Usage: bin/docker-dev [command]
# Commands: up, down, build, logs, console, shell, db:reset, db:migrate, test

set -e

case "$1" in
  "up")
    echo "Starting development environment..."
    docker compose up -d
    echo "Development environment is running at http://localhost:3000"
    echo "Database is available at localhost:5432"
    ;;
  "down")
    echo "Stopping development environment..."
    docker compose down
    ;;
  "build")
    echo "Building development containers..."
    docker compose build
    ;;
  "logs")
    docker compose logs -f
    ;;
  "console")
    docker compose exec web bin/rails console
    ;;
  "shell")
    docker compose exec web bash
    ;;
  "db:reset")
    echo "Resetting database..."
    docker compose exec web bin/rails db:drop db:create db:migrate db:seed
    ;;
  "db:migrate")
    echo "Running migrations..."
    docker compose exec web bin/rails db:migrate
    ;;
  "db:seed")
    echo "Seeding database..."
    docker compose exec web bin/rails db:seed
    ;;
  "test")
    echo "Running tests..."
    docker compose exec web bash -c "DATABASE_URL=postgres://postgres:password@db:5432/rvcc_test RAILS_ENV=test bundle exec rspec"
    # docker compose exec web bash -c "DATABASE_URL=postgres://postgres:password@db:5432/rvcc_test RAILS_ENV=test bundle exec rails db:create"  // use before first run
    ;;
  "clean")
    echo "Cleaning up containers and volumes..."
    docker compose down -v
    docker system prune -f
    ;;
  "restart")
    echo "Restarting development environment..."
    docker compose restart
    ;;
  *)
    echo "Usage: bin/docker-dev [command]"
    echo ""
    echo "Commands:"
    echo "  up          - Start development environment"
    echo "  down        - Stop development environment"
    echo "  build       - Build containers"
    echo "  logs        - Show logs"
    echo "  console     - Open Rails console"
    echo "  shell       - Open shell in container"
    echo "  db:reset    - Reset database"
    echo "  db:migrate  - Run migrations"
    echo "  db:seed     - Seed database"
    echo "  test        - Run tests"
    echo "  clean       - Clean up containers and volumes"
    echo "  restart     - Restart services"
    ;;
esac 